m3_stock_dataset:
  type: pandas.SQLQueryDataset
  credentials: wolfdb_M3_sql
  sql: >
   SELECT 
      mit.ITNO AS SKU,
      mas.ITTY AS Type,
      mit.WHLO AS Depot,
      mit.WHSL AS Emplacement,
      mit.BANO AS Lot,
      SUM(mit.STQT) AS Quantite,
      COALESCE(pop.POPN, 'N/A') AS WMS
    FROM M3.dbo.MITLOC mit
    LEFT JOIN M3.dbo.MITPOP pop 
      ON pop.ITNO = mit.ITNO 
      AND pop.ALWT = 3
      AND pop.ALWQ = 'WMS'
    LEFT JOIN M3.dbo.MITMAS mas
      ON mas.ITNO = mit.ITNO
    WHERE mit.WHLO NOT IN ('300', '301', '302') 
    GROUP BY 
      mit.ITNO,
      mas.ITTY,
      mit.WHLO,
      mit.WHSL,
      mit.BANO,
      pop.POPN;

m3_po_dataset:
  type: pandas.SQLQueryDataset
  credentials: wolfdb_M3_sql
  sql: >
    SELECT 
      h.WHLO AS Depot,
      h.PUNO AS PO
    FROM m3.dbo.MPHEAD as h
    WHERE h.WHLO = 150

reflex_stock_dataset:
  type: pandas.SQLQueryDataset
  credentials: wolfdb_REFLEX_sql
  sql: >
    SELECT 
        src.GECART AS SKU,
        src.GECQAL AS Qualite_Origine,
        CASE
            WHEN src.GECQAL = 'DES' THEN 'DES'
            WHEN src.GECQAL = 'DEF' THEN 'DEF'
            WHEN src.GECQAL IN ('CAT', 'QUA', 'REC', 'RET') THEN 'NDISP'
            WHEN src.GECQAL = 'BLO' THEN 'REJET'
            ELSE 'STOCK'
        END AS Emplacement,
        sum(src.GEQGEI) AS Stock_en_VL,
        src.GELOTF AS Lot_1
    FROM 
        REFLEX.dbo.HLGEINP AS src
    WHERE 
        src.GECACT = 'WLF' AND src.GECTST in ('020','200')
    GROUP BY 
        src.GECACT, 
        src.GECDPO, 
        src.GECART, 
        src.GECQAL, 
        src.GELOTF
    ORDER BY 
        src.GECACT ASC

# Entrées parquet produits par le pipeline d’extraction
m3_stock_parquet:
  type: pandas.ParquetDataset
  filepath: data/01_raw/m3_stock.parquet

reflex_stock_parquet:
  type: pandas.ParquetDataset
  filepath: data/01_raw/reflet_stock.parquet

# categorisations 
# optionnel pour relancer le pipeline au milieu, sinon superflu
m3_cat:
  type: pandas.ParquetDataset
  filepath: data/02_intermediate/m3_cat.parquet

reflex_cat:
  type: pandas.ParquetDataset
  filepath: data/02_intermediate/rfx_cat.parquet

# Sorties intermédiaires - réconciliation

m3_reliquat:
  type: pandas.ParquetDataset
  filepath: data/03_primary/m3_reliquat.parquet

corr_dataset:
  type: pandas.ParquetDataset
  filepath: data/03_primary/rfx_m3_corr.parquet


# table de régulation
reflex_m3_regul:
  type: pandas.ParquetDataset
  filepath: data/04_feature/reflex_m3_regul.parquet


# Sortie de la régulation M3 au format STOCK_M3_RFX
stock_m3_rfx:
  type: pandas.CSVDataset
  filepath: data/05_model_input/API-MMS310MI.Update.csv
  save_args:
    index: False
