m3_stock_dataset:
  type: pandas.SQLQueryDataset
  credentials: wolfdb_M3_sql
  sql: >
   SELECT 
      mit.ITNO AS SKU,
      mas.ITTY AS Type,
      mit.WHLO AS Depot,
      mit.WHSL AS Emplacement,
      mit.BANO AS Lot,
      SUM(mit.STQT) AS Quantite,
      COALESCE(pop.POPN, 'N/A') AS WMS
    FROM M3.dbo.MITLOC mit
    LEFT JOIN M3.dbo.MITPOP pop 
      ON pop.ITNO = mit.ITNO 
      AND pop.ALWT = 3
      AND pop.ALWQ = 'WMS'
    LEFT JOIN M3.dbo.MITMAS mas
      ON mas.ITNO = mit.ITNO
    WHERE mit.WHLO NOT IN ('300', '301', '302') 
    GROUP BY 
      mit.ITNO,
      mas.ITTY,
      mit.WHLO,
      mit.WHSL,
      mit.BANO,
      pop.POPN;

reflex_stock_dataset:
  type: pandas.SQLQueryDataset
  credentials: wolfdb_REFLEX_sql
  sql: >
    SELECT 
        src.GECART AS SKU,
        src.GECQAL AS Qualite_Origine,
        CASE
            WHEN src.GECQAL = 'DES' THEN 'DES'
            WHEN src.GECQAL = 'DEF' THEN 'DEF'
            WHEN src.GECQAL IN ('CAT', 'QUA', 'REC', 'RET') THEN 'NDISP'
            WHEN src.GECQAL = 'BLO' THEN 'REJET'
            ELSE 'STOCK'
        END AS Emplacement,
        sum(src.GEQGEI) AS Stock_en_VL,
        src.GELOTF AS Lot_1
    FROM 
        REFLEX.dbo.HLGEINP AS src
    WHERE 
        src.GECACT = 'WLF' AND src.GECTST in ('020','200')
    GROUP BY 
        src.GECACT, 
        src.GECDPO, 
        src.GECART, 
        src.GECQAL, 
        src.GELOTF
    ORDER BY 
        src.GECACT ASC

# Entrées parquet produits par le pipeline d’extraction
m3_stock_parquet:
  type: pandas.ParquetDataset
  filepath: data/01_raw/m3_stock.parquet

reflex_stock_parquet:
  type: pandas.ParquetDataset
  filepath: data/01_raw/reflet_stock.parquet

# Sorties intermédiaires - réconciliation
reflex_m3_wide:
  type: pandas.ParquetDataset
  filepath: data/02_intermediate/reflex_m3_wide.parquet

m3_reliquat:
  type: pandas.ParquetDataset
  filepath: data/02_intermediate/m3_reliquat.parquet

reflex_m3_wide_filtered:
  type: pandas.ParquetDataset
  filepath: data/02_intermediate/reflex_m3_wide.parquet

